<div class="classes-container">
    <p-toast position="top-right"></p-toast>
    <p-confirmdialog></p-confirmdialog>
    
    <header class="page-header">
        <div class="header-content">
            <h1>Gesti√≥n de Clases</h1>
            <p>Planificaci√≥n y Asistencia</p>
        </div>
        <button pButton label="Nueva Clase" icon="pi pi-plus" (click)="abrirNuevo()"></button>
    </header>

    <div class="filters-container mb-4 card">
        <div class="filters-row p-fluid">
            <div class="filter-item">
                <p-datepicker [(ngModel)]="filtroFecha" placeholder="Fecha" (onSelect)="aplicarFiltros()" [showClear]="true" (onClear)="aplicarFiltros()" dateFormat="dd/mm/yy"></p-datepicker>
            </div>
            <div class="filter-item">
                <p-select [options]="grupos" [(ngModel)]="filtroGrupoId" optionLabel="nombre" optionValue="id" placeholder="Grupo" (onChange)="aplicarFiltros()" [showClear]="true" appendTo="body"></p-select>
            </div>
            <div class="filter-item">
                <p-select [options]="profesores" [(ngModel)]="filtroProfesorId" optionLabel="nombreCompleto" optionValue="id" placeholder="Profesor" (onChange)="aplicarFiltros()" [showClear]="true" appendTo="body"></p-select>
            </div>
            <div class="filter-item button-item">
                <button pButton icon="pi pi-filter-slash" class="p-button-outlined p-button-secondary" (click)="limpiarFiltros()"></button>
            </div>
        </div>
    </div>

    <div class="card-table">
        <p-table [value]="clases" [loading]="loading" [rows]="10" [paginator]="true" styleClass="p-datatable-sm">
            <ng-template pTemplate="header">
                <tr>
                    <th>Fecha / Hora</th>
                    <th>Grupo</th>
                    <th>Tipo</th>
                    <th>Lugar</th>
                    <th>Profesor</th>
                    <th style="width: 160px; text-align: center;">Acciones</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
                <tr>
                    <td>
                        <div class="font-bold">{{ item.fecha | date: 'dd/MM/yyyy' }}</div>
                        <div class="text-sm text-gray-500">{{ item.hora | slice:0:5 }}</div>
                    </td>
                    <td><p-tag [value]="item.grupos?.nombre" severity="info"></p-tag></td>
                    <td><p-tag [value]="item.tipo_entrenamiento" [severity]="item.tipo_entrenamiento === 'ARQUEROS' ? 'warn' : 'success'"></p-tag></td>
                    <td>{{ item.lugar }}</td>
                    <td>{{ item.profesores?.nombre }} {{ item.profesores?.apellido }}</td>
                    <td class="text-center">
                        <div class="flex justify-content-center gap-2">
                            <button pButton icon="pi pi-check-square" class="p-button-text p-button-info" (click)="verAsistencia(item)"></button>
                            <button pButton icon="pi pi-pencil" class="p-button-text p-button-warning" (click)="abrirEditar(item)"></button>
                            <button pButton icon="pi pi-trash" class="p-button-text p-button-danger" (click)="eliminarClase(item.id)"></button>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <p-dialog [(visible)]="displayAttendanceDialog" [header]="'Asistencia: ' + (claseSeleccionada?.grupos?.nombre)" [modal]="true" [style]="{width: '450px'}" styleClass="p-fluid">
        <ng-template pTemplate="content">
            <p-table [value]="alumnosAsistencia" [loading]="loadingAsistencia" scrollable="true" scrollHeight="300px" styleClass="p-datatable-sm">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Estudiante</th>
                        <th style="width: 70px; text-align: center;">Vino</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-alumno>
                    <tr>
                        <td class="text-sm">{{ alumno.nombre }} {{ alumno.apellido }}</td>
                        <td class="text-center"><p-checkbox [(ngModel)]="alumno.presente" [binary]="true"></p-checkbox></td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr><td colspan="2" class="text-center p-3 text-sm">No hay estudiantes en este grupo.</td></tr>
                </ng-template>
            </p-table>
        </ng-template>
        <ng-template pTemplate="footer">
            <button pButton label="Guardar" (click)="guardarAsistencia()" [loading]="loadingAsistencia" [disabled]="alumnosAsistencia.length === 0"></button>
        </ng-template>
    </p-dialog>

    <p-dialog [(visible)]="displayDialog" [header]="tituloDialogo" [modal]="true" [style]="{width: '500px'}" styleClass="p-fluid">
        <ng-template pTemplate="content">
            <p-tabs [(value)]="activeTab">
                <p-tablist><p-tab value="0">Log√≠stica</p-tab><p-tab value="1">Planificaci√≥n</p-tab></p-tablist>
                <p-tabpanels>
                    <p-tabpanel value="0">
                        <div class="flex flex-column gap-3 pt-3">
                            <div class="field"><label>Fecha</label><p-datepicker [(ngModel)]="claseForm.fecha" dateFormat="dd/mm/yy" appendTo="body"></p-datepicker></div>
                            <div class="field"><label>Hora</label><p-datepicker [(ngModel)]="claseForm.hora" [timeOnly]="true" appendTo="body"></p-datepicker></div>
                            <div class="field"><label>Lugar</label><input pInputText [(ngModel)]="claseForm.lugar" /></div>
                            <hr>
                            
                            <div class="field">
                                <label>Grupo</label>
                                <p-select [options]="grupos" 
                                          [(ngModel)]="claseForm.grupo_id" 
                                          optionLabel="nombre" 
                                          optionValue="id"
                                          (onChange)="onGrupoChange($event.value)"
                                          placeholder="Seleccionar grupo"
                                          appendTo="body">
                                </p-select>
                            </div>

                            <div class="field">
                                <label>Profesor</label>
                                <p-select [options]="profesoresFiltrados" 
                                          [(ngModel)]="claseForm.profesor_id" 
                                          optionLabel="nombreCompleto" 
                                          optionValue="id"
                                          [disabled]="!claseForm.grupo_id"
                                          placeholder="Seleccione grupo primero"
                                          appendTo="body">
                                </p-select>
                                <small *ngIf="!claseForm.grupo_id" class="text-secondary block mt-1">
                                    * Seleccione un grupo para ver sus profesores asignados.
                                </small>
                            </div>
                        </div>
                    </p-tabpanel>
                    <p-tabpanel value="1">
                        <div class="flex flex-column gap-3 pt-3">
                            <div class="field"><label class="font-bold">Objetivo</label><input pInputText [(ngModel)]="claseForm.objetivo" /></div>
                            <div class="field"><label>üî• Calentamiento</label><textarea pTextarea [(ngModel)]="claseForm.calentamiento" rows="3"></textarea></div>
                            <div class="field"><label>‚öΩ Parte Principal</label><textarea pTextarea [(ngModel)]="claseForm.parte_principal" rows="5"></textarea></div>
                            <div class="field"><label>‚ùÑÔ∏è Vuelta a la Calma</label><textarea pTextarea [(ngModel)]="claseForm.vuelta_calma" rows="2"></textarea></div>
                        </div>
                    </p-tabpanel>
                </p-tabpanels>
            </p-tabs>
        </ng-template>
        <ng-template pTemplate="footer">
            <button pButton label="Guardar" (click)="guardarClase()"></button>
        </ng-template>
    </p-dialog>
</div>