<div class="classes-container">
    <p-toast position="top-right"></p-toast>
    <p-confirmDialog></p-confirmDialog>
    
    <header class="page-header">
        <div class="header-content">
            <h1>Gesti√≥n de Clases</h1>
            <p>Planificaci√≥n de entrenamientos y control de asistencia</p>
        </div>
        <button pButton label="Nueva Clase" icon="pi pi-plus" class="btn-create" (click)="abrirNuevo()"></button>
    </header>

    <div class="filters-container card mb-4">
        <div class="filters-row">
            
            <div class="filter-item">
                <p-datepicker [(ngModel)]="filtroFecha" placeholder="Filtrar por Fecha" (onSelect)="aplicarFiltros()" [showClear]="true" (onClear)="aplicarFiltros()" dateFormat="dd/mm/yy" [style]="{'width':'100%'}"></p-datepicker>
            </div>

            <div class="filter-item">
                <p-select [options]="grupos" [(ngModel)]="filtroGrupoId" optionLabel="nombre" optionValue="id" placeholder="Filtrar por Grupo" (onChange)="aplicarFiltros()" [showClear]="true" appendTo="body" [style]="{'width':'100%'}"></p-select>
            </div>

            <div class="filter-item">
                    <input pInputText type="text" [(ngModel)]="filtroLugar" (input)="aplicarFiltros()" placeholder="Buscar Lugar..." class="w-full"/>
            </div>

            <div class="filter-item button-item">
                <button pButton icon="pi pi-filter-slash" class="p-button-outlined p-button-secondary w-full" (click)="limpiarFiltros()" pTooltip="Limpiar Filtros"></button>
            </div>
        </div>
    </div>

    <div class="card-table table-responsive">
        <p-table [value]="clases" [loading]="loading" [rows]="10" [paginator]="true" styleClass="p-datatable-sm" [rowHover]="true">
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 25%">Fecha / Hora</th>
                    <th style="width: 25%">Grupo</th>
                    <th style="width: 30%">Lugar</th>
                    <th style="width: 20%" class="text-center">Acciones</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
                <tr>
                    <td>
                        <div class="font-bold text-main">{{ item.fecha | date: 'dd/MM/yyyy' }}</div>
                        <div class="text-sm text-500 flex align-items-center mt-1">
                            <i class="pi pi-clock mr-1 text-xs"></i>{{ item.hora | slice:0:5 }}
                        </div>
                    </td>
                    
                    <td><p-tag [value]="item.grupos?.nombre" severity="info"></p-tag></td>
                    
                    <td class="text-main">
                        <i class="pi pi-map-marker text-primary mr-1"></i>{{ item.lugar }}
                    </td>
                    
                    <td class="text-center">
                        <div class="action-buttons">
                            <button pButton icon="pi pi-check-square" class="p-button-text p-button-info p-button-rounded" (click)="verAsistencia(item)" pTooltip="Asistencia"></button>
                            <button pButton icon="pi pi-pencil" class="p-button-text p-button-warning p-button-rounded" (click)="abrirEditar(item)"></button>
                            <button pButton icon="pi pi-trash" class="p-button-text p-button-danger p-button-rounded" (click)="eliminarClase(item.id)"></button>
                        </div>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr><td colspan="4" class="text-center p-4 text-secondary">No hay clases registradas con estos filtros.</td></tr>
            </ng-template>
        </p-table>
    </div>

    <p-dialog [(visible)]="displayAttendanceDialog" [header]="'Asistencia: ' + (claseSeleccionada?.grupos?.nombre)" [modal]="true" [style]="{width: '90vw', maxWidth: '450px'}" styleClass="p-fluid">
        <ng-template pTemplate="content">
            <p-table [value]="alumnosAsistencia" [loading]="loadingAsistencia" scrollable="true" scrollHeight="300px" styleClass="p-datatable-sm">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Estudiante</th>
                        <th style="width: 80px; text-align: center;">Presente</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-alumno>
                    <tr>
                        <td class="text-sm text-main">{{ alumno.nombre }} {{ alumno.apellido }}</td>
                        <td class="text-center">
                            <p-checkbox [(ngModel)]="alumno.presente" [binary]="true"></p-checkbox>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr><td colspan="2" class="text-center p-3 text-sm text-secondary">No hay estudiantes activos en este grupo.</td></tr>
                </ng-template>
            </p-table>
        </ng-template>
        <ng-template pTemplate="footer">
            <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text" (click)="displayAttendanceDialog = false"></button>
            <button pButton label="Guardar Asistencia" icon="pi pi-check" (click)="guardarAsistencia()" [loading]="loadingAsistencia" [disabled]="alumnosAsistencia.length === 0"></button>
        </ng-template>
    </p-dialog>

    <p-dialog [(visible)]="displayDialog" [header]="tituloDialogo" [modal]="true" [style]="{width: '90vw', maxWidth: '550px'}" styleClass="p-fluid">
        <ng-template pTemplate="content">
            
            <div class="flex justify-content-center mb-4">
                <p-selectButton [options]="opcionesVistaForm" [(ngModel)]="vistaFormulario" optionLabel="label" optionValue="value">
                    <ng-template let-item pTemplate="item">
                        <i [class]="item.icon"></i>
                        <span>{{item.label}}</span>
                    </ng-template>
                </p-selectButton>
            </div>

            <div *ngIf="vistaFormulario === 'logistica'" class="animation-fade-in">
                
                <div class="field">
                    <label><i class="pi pi-users"></i> Grupo</label>
                    <p-select [options]="grupos" [(ngModel)]="claseForm.grupo_id" optionLabel="nombre" optionValue="id" placeholder="Seleccionar grupo" appendTo="body"></p-select>
                </div>

                <div class="formgrid grid">
                    <div class="field col-6">
                        <label><i class="pi pi-calendar"></i> Fecha</label>
                        <p-datepicker [(ngModel)]="claseForm.fecha" dateFormat="dd/mm/yy" appendTo="body" [showIcon]="true"></p-datepicker>
                    </div>
                    <div class="field col-6">
                        <label><i class="pi pi-clock"></i> Hora</label>
                        <input pInputText type="time" [(ngModel)]="claseForm.hora" class="w-full">
                    </div>
                </div>

                <div class="field">
                    <label><i class="pi pi-map-marker"></i> Lugar de Entrenamiento</label>
                    <input pInputText [(ngModel)]="claseForm.lugar" placeholder="Ej: Cancha 3" />
                </div>
                
            </div>

            <div *ngIf="vistaFormulario === 'planificacion'" class="animation-fade-in">
                
                <div class="field">
                    <label class="font-bold text-primary"><i class="pi pi-directions"></i> Objetivo Principal</label>
                    <input pInputText [(ngModel)]="claseForm.objetivo" placeholder="Ej: Mejora del pase corto" />
                </div>
                
                <div class="field">
                    <label><span>üî•</span> Calentamiento</label>
                    <textarea pTextarea [(ngModel)]="claseForm.calentamiento" rows="3" placeholder="Descripci√≥n del calentamiento..."></textarea>
                </div>
                
                <div class="field">
                    <label><span>‚öΩ</span> Parte Principal</label>
                    <textarea pTextarea [(ngModel)]="claseForm.parte_principal" rows="5" placeholder="Ejercicios principales..."></textarea>
                </div>
                
                <div class="field">
                    <label><span>‚ùÑÔ∏è</span> Vuelta a la Calma</label>
                    <textarea pTextarea [(ngModel)]="claseForm.vuelta_calma" rows="2" placeholder="Estiramientos finales..."></textarea>
                </div>

            </div>

        </ng-template>

        <ng-template pTemplate="footer">
            <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text" (click)="displayDialog = false"></button>
            <button pButton label="Guardar Clase" icon="pi pi-check" (click)="guardarClase()"></button>
        </ng-template>
    </p-dialog>
</div>