<div class="users-container">
    <p-toast position="top-right"></p-toast>
    <p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>

    <header class="page-header">
        <div class="header-content">
            <div>
                <h1>Gestión de Usuarios</h1>
                <p>Administra los roles y perfiles de la academia.</p>
            </div>
        </div>
        <button pButton label="Nuevo Usuario" icon="pi pi-plus" class="btn-create" (click)="abrirNuevo()"></button>
    </header>

    <div class="view-selector-container mb-3">
        <div class="selector-wrapper">
            <div class="icon-box"><i class="pi pi-users"></i></div>
            <p-select [options]="opcionesVista" [(ngModel)]="vistaActual" (onChange)="cambiarVista()" 
                      optionLabel="label" optionValue="value" styleClass="w-full"></p-select>
        </div>
    </div>

    <div class="filter-bar card mb-3 p-3 surface-card border-round shadow-1">
        <div class="filter-row">
            
            <div class="filter-item flex-grow-2">
                <label>Buscador</label>
                <input pInputText type="text" [(ngModel)]="filtros.global" 
                       (input)="dt.filterGlobal(filtros.global, 'contains')" 
                       placeholder="Nombre, RUT o Email..." class="w-full"/>
            </div>

            <ng-container *ngIf="vistaActual === 'estudiantes'">
                <div class="filter-item flex-grow-1">
                    <label>Grupos</label>
                    <p-multiSelect [options]="listaGrupos" [(ngModel)]="filtros.grupo" 
                                   optionLabel="nombre" optionValue="id" placeholder="Todos" 
                                   (onChange)="dt.filter($event.value, 'grupo_id', 'in')" 
                                   display="chip" [showClear]="true" styleClass="w-full"
                                   [maxSelectedLabels]="1" selectedItemsLabel="{0} grupos"></p-multiSelect>
                </div>
                <div class="filter-item flex-grow-1">
                    <label>Posiciones</label>
                    <p-multiSelect [options]="listaPosiciones" [(ngModel)]="filtros.posicion"
                                   optionLabel="nombre" optionValue="id" placeholder="Todas"
                                   (onChange)="dt.filter($event.value, 'estudiantes_posiciones', 'contienePosicion')"
                                   display="chip" [showClear]="true" styleClass="w-full"
                                   [maxSelectedLabels]="1" selectedItemsLabel="{0} pos."></p-multiSelect>
                </div>
            </ng-container>

            <ng-container *ngIf="vistaActual === 'profesores'">
                <div class="filter-item flex-grow-2">
                    <label>Especialidad</label>
                    <p-multiSelect [options]="listaTiposProfesor" [(ngModel)]="filtros.tipoProfesor"
                                   optionLabel="label" optionValue="value" placeholder="Todas las especialidades"
                                   (onChange)="dt.filter($event.value, 'tipo_profesor', 'in')" 
                                   display="chip" [showClear]="true" styleClass="w-full"
                                   [maxSelectedLabels]="1" selectedItemsLabel="{0} tipos"></p-multiSelect>
                </div>
            </ng-container>

             <div class="filter-item flex-grow-2" *ngIf="vistaActual !== 'estudiantes' && vistaActual !== 'profesores'"></div>

            <div class="filter-item w-10rem">
                <label>Estado</label>
                <p-select [options]="opcionesEstado" [(ngModel)]="filtros.estado" 
                          placeholder="Todos" (onChange)="dt.filter($event.value, 'activo', 'equals')" 
                          [showClear]="true" styleClass="w-full">
                    <ng-template let-option pTemplate="item">
                        <p-tag [value]="option.label" [severity]="option.value ? 'success' : 'danger'"></p-tag>
                    </ng-template>
                </p-select>
            </div>

            <div class="filter-item-btn">
                <button pButton icon="pi pi-filter-slash" 
                        class="p-button-outlined p-button-secondary w-full" 
                        (click)="limpiarFiltros()" pTooltip="Limpiar"></button>
            </div>
        </div>
    </div>

    <div class="main-card">
        <p-table #dt [value]="dataList" [loading]="loading" [rows]="10" [paginator]="true" 
                 styleClass="p-datatable-sm" [rowHover]="true" 
                 [globalFilterFields]="['nombre', 'apellido', 'rut', 'email', 'tipo_profesor']">
            
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 4rem"></th> 
                    
                    <th pSortableColumn="nombre">Nombre / RUT <p-sortIcon field="nombre"></p-sortIcon></th>
                    <th class="text-center" *ngIf="vistaActual === 'estudiantes'">F. Nac / Edad</th>
                    <th *ngIf="vistaActual === 'estudiantes'">Grupo</th>
                    <th *ngIf="vistaActual === 'estudiantes'">Posiciones</th>
                    <th *ngIf="vistaActual === 'profesores'">Especialidad / Grupos</th>
                    <th class="hidden-mobile">Email</th>
                    <th class="text-center">Estado</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-item>
                <tr [ngClass]="{'row-inactive': !item.activo}">
                    
                    <td>
                        <div class="flex align-items-center justify-content-center">
                            <img [src]="item.foto_url || 'assets/images/default-user.png'" 
                                alt="Avatar" 
                                class="avatar-img">
                        </div>
                    </td>

                    <td>
                        <div class="font-bold text-main">{{ item.nombre }} {{ item.apellido }}</div>
                        <div class="text-xs text-secondary mt-1"><i class="pi pi-id-card"></i> {{ item.rut || 'Sin RUT' }}</div>
                    </td>
                    
                    <td class="text-center" *ngIf="vistaActual === 'estudiantes'">
                        <div *ngIf="item.fecha_nacimiento" class="fecha-nac-container">
                            <span class="fecha-nac-text">{{ item.fecha_nacimiento | date:'dd/MM/yyyy' }}</span>
                            <span class="edad-text"><i class="pi pi-calendar mr-1"></i> {{ calcularEdad(item.fecha_nacimiento) }} años</span>
                        </div>
                        <span *ngIf="!item.fecha_nacimiento" class="text-secondary">-</span>
                    </td>

                    <td *ngIf="vistaActual === 'estudiantes'"><p-tag [value]="item.grupos?.nombre || 'Sin Grupo'" [severity]="item.grupos ? 'info' : 'secondary'"></p-tag></td>
                    <td *ngIf="vistaActual === 'estudiantes'">
                        <div class="flex gap-1 flex-wrap">
                            <p-tag *ngFor="let p of item.estudiantes_posiciones" [value]="p.posiciones?.nombre" severity="warn"></p-tag>
                        </div>
                    </td>
                    <td *ngIf="vistaActual === 'profesores'">
                        <div class="flex gap-1 flex-wrap mb-1"><p-tag *ngFor="let gp of item.grupos_profesores" [value]="gp.grupos?.nombre" severity="success"></p-tag></div>
                        <small class="text-secondary">{{ item.tipo_profesor }}</small>
                    </td>
                    <td class="hidden-mobile text-sm">{{ item.email }}</td>
                    <td class="text-center"><p-tag [severity]="item.activo ? 'success' : 'danger'" [value]="item.activo ? 'ACTIVO' : 'INACTIVO'" [rounded]="true"></p-tag></td>
                    <td class="text-center">
                        <div class="action-buttons">
                            <button pButton icon="pi pi-pencil" class="p-button-text p-button-warning" (click)="abrirEditar(item)"></button>
                            <button pButton [icon]="item.activo ? 'pi pi-lock-open' : 'pi pi-lock'" [class]="item.activo ? 'p-button-text p-button-success' : 'p-button-text p-button-danger'" (click)="toggleEstado(item)"></button>
                            <button pButton icon="pi pi-trash" class="p-button-text p-button-danger" (click)="eliminar(item)"></button>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <p-dialog [(visible)]="displayDialog" [header]="tituloDialogo" [modal]="true" [style]="{width: '90vw', maxWidth: '500px'}" styleClass="p-fluid">
        <div class="flex flex-column gap-3 pt-2">

            <div class="field photo-section">
                <div class="photo-upload-wrapper">
                    <div class="avatar-preview-container shadow-4">
                        <img *ngIf="previewUrl" [src]="previewUrl" alt="Vista previa">
                        
                        <div *ngIf="!previewUrl" class="avatar-placeholder">
                            <i class="pi pi-camera"></i>
                        </div>

                        <div *ngIf="uploadingFoto" class="loading-overlay">
                            <i class="pi pi-spin pi-spinner text-3xl text-white"></i>
                        </div>
                    </div>

                    <div class="photo-actions">
                        <p-fileUpload mode="basic" 
                                    chooseIcon="pi pi-plus" 
                                    chooseLabel="Elegir foto" 
                                    accept="image/*" 
                                    [auto]="true" 
                                    [customUpload]="true" 
                                    (uploadHandler)="onFileSelected($event)"
                                    styleClass="p-button-rounded p-button-outlined btn-icon-only">
                        </p-fileUpload>

                        <button *ngIf="previewUrl" 
                                pButton 
                                icon="pi pi-trash" 
                                class="p-button-rounded p-button-danger p-button-text btn-icon-only"
                                (click)="clearFoto()">
                        </button>
                    </div>
                </div>
            </div>

            <div class="field">
                <label><i class="pi pi-envelope"></i> Email <span class="text-red-500 font-bold">*</span></label>
                <input pInputText [(ngModel)]="userForm.email" />
            </div>
            
            <div class="formgrid grid">
                <div class="field col-6">
                    <label><i class="pi pi-user"></i> Nombre <span class="text-red-500 font-bold">*</span></label>
                    <input pInputText [(ngModel)]="userForm.nombre" />
                </div>
                <div class="field col-6">
                    <label><i class="pi pi-user"></i> Apellido <span class="text-red-500 font-bold">*</span></label>
                    <input pInputText [(ngModel)]="userForm.apellido" />
                </div>
            </div>
            
            <div class="field">
                <label><i class="pi pi-id-card"></i> RUT <span class="text-red-500 font-bold">*</span></label>
                <input pInputText appRutFormat [(ngModel)]="userForm.rut" placeholder="12.345.678-9" />
            </div>
            
            <div class="field" *ngIf="vistaActual === 'estudiantes'">
                <label><i class="pi pi-calendar"></i> Fecha de Nacimiento <span class="text-red-500 font-bold">*</span></label>
                <p-datepicker [(ngModel)]="userForm.fecha_nacimiento" [showIcon]="true" appendTo="body" dateFormat="dd/mm/yy" [maxDate]="maxDate" placeholder="Selecciona fecha"></p-datepicker>
                <small class="text-primary font-bold mt-1 block" *ngIf="userForm.fecha_nacimiento">Edad calculada: {{ calcularEdad(userForm.fecha_nacimiento) }} años</small>
            </div>
            
            <div class="field bg-blue-50 p-3 border-round" *ngIf="!isEditing">
                <span class="text-blue-700 text-sm font-medium">
                    <i class="pi pi-info-circle mr-1"></i> La contraseña inicial se generará automáticamente usando el RUT del usuario (sin puntos ni guiones).
                </span>
            </div>
            
            <ng-container *ngIf="vistaActual === 'estudiantes'">
                <div class="field">
                    <label><i class="pi pi-users"></i> Grupo</label> <p-select [options]="listaGrupos" [(ngModel)]="userForm.grupo_id" optionLabel="nombre" optionValue="id" placeholder="Selecciona grupo" appendTo="body" [showClear]="true"></p-select>
                </div>
                <div class="field">
                    <label><i class="pi pi-map"></i> Posiciones de Juego</label>
                    <p-multiSelect [options]="listaPosiciones" [(ngModel)]="userForm.posicionesIds" optionLabel="nombre" optionValue="id" placeholder="Seleccionar" display="chip" appendTo="body"></p-multiSelect>
                </div>
            </ng-container>
            
            <ng-container *ngIf="vistaActual === 'profesores'">
                <div class="field">
                    <label><i class="pi pi-briefcase"></i> Especialidad <span class="text-red-500 font-bold">*</span></label> <p-select [options]="listaTiposProfesor" [(ngModel)]="userForm.tipo_profesor" optionLabel="label" optionValue="value" placeholder="Seleccione" appendTo="body"></p-select>
                </div>
                <div class="field">
                    <label><i class="pi pi-sitemap"></i> Grupos a Cargo</label>
                    <p-multiSelect [options]="listaGrupos" [(ngModel)]="userForm.gruposIds" placeholder="Seleccionar grupos" optionLabel="nombre" optionValue="id" display="chip" appendTo="body"></p-multiSelect>
                </div>
            </ng-container>
        </div>

        <ng-template pTemplate="footer">
            <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text" (click)="displayDialog = false"></button>
            <button pButton label="Guardar" icon="pi pi-check" (click)="guardar()" [loading]="loading"></button>
        </ng-template>
    </p-dialog>
</div>