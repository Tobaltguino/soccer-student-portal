<div class="users-container">
    
    <p-toast position="top-right"></p-toast>

    <header class="page-header">
        <div class="header-content">
            <button pButton icon="pi pi-arrow-left" class="p-button-text p-button-rounded" routerLink="/admin-dashboard"></button>
            <div>
                <h1>Gestión de Usuarios</h1>
                <p>Administra los roles y perfiles de la academia.</p>
            </div>
        </div>
        <button pButton label="Nuevo Usuario" icon="pi pi-plus" class="btn-create" (click)="abrirDialogoCrear()"></button>
    </header>

    <div class="tabs-wrapper">
        <p-tabs [(value)]="activeTab">
            
            <p-tablist>
                <p-tab value="0">Estudiantes</p-tab>
                <p-tab value="1">Profesores</p-tab>
                <p-tab value="2">Administradores</p-tab>
                <p-tab value="3">Kinesiólogos</p-tab>
                <p-tab value="4">Nutricionistas</p-tab>
            </p-tablist>

            <p-tabpanels>
                
                <p-tabpanel value="0">
                    
                    <div class="flex align-items-center gap-2 mb-5 px-1">
                        <p-select [options]="listaGrupos" [(ngModel)]="filtroGrupoEst" (onChange)="filtrarEstudiantes()"
                                  optionLabel="nombre" optionValue="id" placeholder="Filtrar por Grupo" 
                                  [showClear]="true" [style]="{'width':'220px'}" appendTo="body" variant="filled">
                        </p-select>

                        <p-select [options]="tiposJugador" [(ngModel)]="filtroTipoEst" (onChange)="filtrarEstudiantes()"
                                  optionLabel="label" optionValue="value" placeholder="Filtrar por Tipo" 
                                  [showClear]="true" [style]="{'width':'220px'}" appendTo="body" variant="filled">
                        </p-select>

                        <button pButton icon="pi pi-filter-slash" class="p-button-text p-button-secondary p-button-rounded" 
                                pTooltip="Limpiar" tooltipPosition="top" (click)="limpiarFiltrosEst()"></button>
                    </div>

                    <p-table [value]="estudiantesFiltrados" [loading]="loadingEstudiantes" [rows]="10" [paginator]="true" styleClass="p-datatable-sm">
                        <ng-template pTemplate="header">
                            <tr>
                                <th>Nombre</th> <th>RUT</th> <th>Email</th> <th>Grupo</th> <th>Tipo</th> <th>Acciones</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-item>
                            <tr>
                                <td class="font-bold">{{ item.nombre }} {{ item.apellido }}</td>
                                <td>{{ item.rut }}</td>
                                <td>{{ item.email }}</td>
                                <td>
                                    <p-tag [value]="item.grupos?.nombre || 'Sin Grupo'" [severity]="item.grupos ? 'info' : 'secondary'"></p-tag>
                                </td>
                                <td><p-tag [value]="item.tipo_alumno" severity="contrast"></p-tag></td>
                                <td>
                                    <div class="action-buttons">
                                        <button pButton icon="pi pi-pencil" class="p-button-text p-button-warning p-button-rounded" (click)="abrirDialogoEditar(item)"></button>
                                        <button pButton icon="pi pi-trash" class="p-button-text p-button-danger p-button-rounded" (click)="eliminarUsuario(item.id, 'estudiantes')"></button>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage"><tr><td colspan="6" class="text-center p-4">No se encontraron estudiantes.</td></tr></ng-template>
                    </p-table>
                </p-tabpanel>

                <p-tabpanel value="1">

                    <div class="flex align-items-center gap-2 mb-5 px-1">
                        <p-select [options]="listaGrupos" [(ngModel)]="filtroGrupoProf" (onChange)="filtrarProfesores()"
                                  optionLabel="nombre" optionValue="id" placeholder="Grupo Asignado" 
                                  [showClear]="true" [style]="{'width':'220px'}" appendTo="body" variant="filled">
                        </p-select>

                        <p-select [options]="tiposJugador" [(ngModel)]="filtroTipoProf" (onChange)="filtrarProfesores()"
                                  optionLabel="label" optionValue="value" placeholder="Tipo de Profesor" 
                                  [showClear]="true" [style]="{'width':'220px'}" appendTo="body" variant="filled">
                        </p-select>

                        <button pButton icon="pi pi-filter-slash" class="p-button-text p-button-secondary p-button-rounded" 
                                pTooltip="Limpiar" tooltipPosition="top" (click)="limpiarFiltrosProf()"></button>
                    </div>

                    <p-table [value]="profesoresFiltrados" [loading]="loadingProfesores">
                        <ng-template pTemplate="header">
                            <tr>
                                <th>Nombre</th> <th>RUT</th> <th>Email</th> <th>Grupos Asignados</th> <th>Tipo</th> <th>Acciones</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-item>
                            <tr>
                                <td class="font-bold">{{ item.nombre }} {{ item.apellido }}</td>
                                <td>{{ item.rut }}</td>
                                <td>{{ item.email }}</td>
                                <td>
                                    <div class="flex gap-1 flex-wrap">
                                        <span *ngIf="!item.grupos_profesores?.length" class="text-sm text-gray-400">-</span>
                                        <p-tag *ngFor="let gp of item.grupos_profesores" [value]="gp.grupos.nombre" severity="success"></p-tag>
                                    </div>
                                </td>
                                <td>{{ item.tipo_profesor }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button pButton icon="pi pi-pencil" class="p-button-text p-button-warning p-button-rounded" (click)="abrirDialogoEditar(item)"></button>
                                        <button pButton icon="pi pi-trash" class="p-button-text p-button-danger p-button-rounded" (click)="eliminarUsuario(item.id, 'profesores')"></button>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage"><tr><td colspan="6" class="text-center p-4">No se encontraron profesores.</td></tr></ng-template>
                    </p-table>
                </p-tabpanel>

                <p-tabpanel value="2">
                    <p-table [value]="admins" [loading]="loadingAdmins">
                        <ng-template pTemplate="header"><tr><th>Nombre</th><th>Email</th><th>Acciones</th></tr></ng-template>
                        <ng-template pTemplate="body" let-item>
                            <tr>
                                <td class="font-bold">{{ item.nombre }} {{ item.apellido }}</td> <td>{{ item.email }}</td>
                                <td><button pButton icon="pi pi-pencil" class="p-button-text p-button-warning p-button-rounded" (click)="abrirDialogoEditar(item)"></button><button pButton icon="pi pi-trash" class="p-button-text p-button-danger p-button-rounded" (click)="eliminarUsuario(item.id, 'admins')"></button></td>
                            </tr>
                        </ng-template>
                    </p-table>
                </p-tabpanel>
                <p-tabpanel value="3">
                    <p-table [value]="kines" [loading]="loadingKines">
                        <ng-template pTemplate="header"><tr><th>Nombre</th><th>RUT</th><th>Email</th><th>Acciones</th></tr></ng-template>
                        <ng-template pTemplate="body" let-item>
                            <tr>
                                <td class="font-bold">{{ item.nombre }} {{ item.apellido }}</td> <td>{{ item.rut }}</td> <td>{{ item.email }}</td>
                                <td><button pButton icon="pi pi-pencil" class="p-button-text p-button-warning p-button-rounded" (click)="abrirDialogoEditar(item)"></button><button pButton icon="pi pi-trash" class="p-button-text p-button-danger p-button-rounded" (click)="eliminarUsuario(item.id, 'kinesiologos')"></button></td>
                            </tr>
                        </ng-template>
                    </p-table>
                </p-tabpanel>
                <p-tabpanel value="4">
                    <p-table [value]="nutris" [loading]="loadingNutris">
                        <ng-template pTemplate="header"><tr><th>Nombre</th><th>RUT</th><th>Email</th><th>Acciones</th></tr></ng-template>
                        <ng-template pTemplate="body" let-item>
                            <tr>
                                <td class="font-bold">{{ item.nombre }} {{ item.apellido }}</td> <td>{{ item.rut }}</td> <td>{{ item.email }}</td>
                                <td><button pButton icon="pi pi-pencil" class="p-button-text p-button-warning p-button-rounded" (click)="abrirDialogoEditar(item)"></button><button pButton icon="pi pi-trash" class="p-button-text p-button-danger p-button-rounded" (click)="eliminarUsuario(item.id, 'nutricionistas')"></button></td>
                            </tr>
                        </ng-template>
                    </p-table>
                </p-tabpanel>

            </p-tabpanels>
        </p-tabs>
    </div>

    <p-dialog [(visible)]="displayDialog" [header]="tituloDialogo" [modal]="true" [style]="{width: '450px'}" styleClass="p-fluid">
        <ng-template pTemplate="content">
            <div class="flex flex-column gap-3 pt-2">
                <div class="field"><label>Nombre</label><input pInputText [(ngModel)]="userForm.nombre" /></div>
                <div class="field"><label>Apellido</label><input pInputText [(ngModel)]="userForm.apellido" /></div>
                <div class="field" *ngIf="activeTab !== '2'"><label>RUT</label><input pInputText [(ngModel)]="userForm.rut" /></div>
                <div class="field"><label>Email</label><input pInputText [(ngModel)]="userForm.email" /></div>
                <div class="field" *ngIf="!isEditing"><label>Contraseña</label><input pInputText type="password" [(ngModel)]="userForm.password" /></div>

                <div class="field" *ngIf="activeTab === '0'">
                    <label>Tipo de Alumno</label>
                    <p-select [options]="tiposJugador" [(ngModel)]="userForm.tipo_alumno" optionLabel="label" optionValue="value" placeholder="Seleccione" appendTo="body"></p-select>
                </div>
                <div class="field" *ngIf="activeTab === '1'">
                    <label>Tipo de Profesor</label>
                    <p-select [options]="tiposJugador" [(ngModel)]="userForm.tipo_profesor" optionLabel="label" optionValue="value" placeholder="Seleccione" appendTo="body"></p-select>
                </div>

                <div class="field" *ngIf="activeTab === '0'">
                    <label class="font-bold block mb-2 text-primary">Asignar Grupo</label>
                    <p-select [options]="listaGrupos" [(ngModel)]="userForm.grupo_id" optionLabel="nombre" optionValue="id" placeholder="Selecciona categoría" [style]="{'width':'100%'}" appendTo="body" [showClear]="true"></p-select>
                </div>
                <div class="field" *ngIf="activeTab === '1'">
                    <label class="font-bold block mb-2 text-primary">Grupos a Cargo</label>
                    <p-multiSelect [options]="listaGrupos" [(ngModel)]="userForm.grupos_profe" defaultLabel="Seleccionar grupos" optionLabel="nombre" optionValue="id" display="chip" [style]="{'width':'100%'}" appendTo="body"></p-multiSelect>
                </div>
            </div>
        </ng-template>
        <ng-template pTemplate="footer">
            <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text" (click)="displayDialog = false"></button>
            <button pButton label="Guardar" icon="pi pi-check" (click)="guardarUsuario()"></button>
        </ng-template>
    </p-dialog>

    <p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>
</div>