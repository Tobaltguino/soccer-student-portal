<div class="eval-container">
    <p-toast position="top-right"></p-toast>
    <p-confirmdialog></p-confirmdialog>

    <header class="page-header">
        <div class="header-content">
            <h1>Evaluaciones Técnicas</h1>
            <p>Gestión de pruebas físicas y resultados.</p>
        </div>
        <div class="header-actions">
            <button pButton label="Configurar Test" icon="pi pi-cog" class="p-button-outlined p-button-secondary btn-responsive" (click)="abrirNuevoTipo()"></button>
            <button pButton label="Nueva Sesión" icon="pi pi-plus" class="btn-create btn-responsive" (click)="abrirNuevo()"></button>
        </div>
    </header>

    <div class="card-table table-responsive">
        <p-table [value]="sesiones" [loading]="loading" [rows]="10" [paginator]="true" styleClass="p-datatable-sm">
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 20%">Fecha</th>
                    <th style="width: 20%">Grupo</th>
                    <th style="width: 25%">Prueba</th>
                    <th style="width: 15%" class="hidden-mobile">Estado</th>
                    <th style="width: 20%" class="text-center">Acciones</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-sesion>
                <tr>
                    <td>
                        <div class="font-bold text-main">{{ sesion.fecha | date:'dd/MM/yyyy' }}</div>
                        <div class="visible-mobile mt-1">
                            <p-tag [value]="sesion.estado" [severity]="sesion.estado === 'PENDIENTE' ? 'warn' : 'success'" styleClass="text-xs"></p-tag>
                        </div>
                    </td>
                    <td><p-tag [value]="sesion.grupos?.nombre" severity="info"></p-tag></td>
                    <td>
                        <span class="font-bold text-main block">{{ sesion.tipo_evaluacion?.nombre }}</span>
                        <div class="text-xs text-secondary mt-1">
                            Unidad: {{ sesion.tipo_evaluacion?.unidad_medida }}
                        </div>
                    </td>
                    <td class="hidden-mobile">
                        <p-tag [value]="sesion.estado" [severity]="sesion.estado === 'PENDIENTE' ? 'warn' : 'success'"></p-tag>
                    </td>
                    <td class="text-center">
                        <div class="action-buttons">
                            <button pButton icon="pi pi-pencil" class="p-button-rounded p-button-text p-button-secondary" (click)="editarSesion(sesion)" pTooltip="Editar Logística"></button>
                            <button pButton icon="pi pi-user-edit" class="p-button-rounded p-button-success" (click)="abrirCalificador(sesion)" pTooltip="Calificar"></button>
                            <button pButton icon="pi pi-trash" class="p-button-rounded p-button-text p-button-danger" (click)="eliminarSesion(sesion.id)" pTooltip="Eliminar"></button>
                        </div>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr><td colspan="5" class="text-center p-4 text-secondary">No hay sesiones registradas.</td></tr>
            </ng-template>
        </p-table>
    </div>

    <p-dialog [(visible)]="displayTipoDialog" header="Gestión de Tests" [modal]="true" [style]="{width: '90vw', maxWidth: '650px'}" styleClass="p-fluid">
        <div class="grid formgrid">
            <div class="col-12 md:col-6 border-right-1 md:border-right-1 surface-border pr-3">
                <h3 class="mt-0 text-main">Nuevo Test</h3>
                <div class="field mt-2">
                    <label>Nombre</label>
                    <input pInputText [(ngModel)]="tipoForm.nombre" placeholder="Ej: Salto Vertical">
                </div>
                <div class="field">
                    <label>Unidad de Medida</label>
                    <input pInputText [(ngModel)]="tipoForm.unidad_medida" placeholder="Ej: cm, seg, repeticiones">
                </div>
                
                <button pButton label="Crear Test" icon="pi pi-plus" class="mt-3 w-full" (click)="guardarNuevoTipo()"></button>
            </div>

            <div class="col-12 md:col-6 pl-0 md:pl-4 mt-4 md:mt-0">
                <h3 class="mt-0 text-main">Tests Existentes</h3>
                <div class="test-list-container">
                    <div *ngFor="let t of tiposEvaluacion" class="test-item">
                        <div>
                            <span class="font-bold text-main block">{{ t.nombre }}</span>
                            <div class="text-sm text-secondary">Unidad: {{ t.unidad_medida }}</div>
                        </div>
                        <button pButton icon="pi pi-trash" class="p-button-rounded p-button-danger p-button-text p-button-sm" (click)="eliminarTipoTest(t.id)"></button>
                    </div>
                    <div *ngIf="tiposEvaluacion.length === 0" class="text-center text-secondary py-3">No hay tests configurados.</div>
                </div>
            </div>
        </div>
    </p-dialog>

    <p-dialog [(visible)]="displayGradesDialog" [header]="'Evaluando: ' + (evalLogistica.tipo_evaluacion?.nombre || '')" [modal]="true" [style]="{width: '95vw', maxWidth: '750px', height: '90vh'}" styleClass="p-fluid full-height-mobile">
        
        <p-table [value]="estudiantesGrupo" scrollable="true" scrollHeight="flex" styleClass="p-datatable-striped p-datatable-sm">
            <ng-template pTemplate="header">
                <tr>
                    <th style="min-width: 120px">Estudiante</th>
                    <th style="min-width: 160px" class="text-center">Marca ({{ evalLogistica.tipo_evaluacion?.unidad_medida }})</th>
                    <th style="min-width: 100px" class="hidden-mobile">Observación</th>
                    <th style="width: 40px"></th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-est>
                <tr>
                    <td>
                        <div class="font-bold text-main">{{ est.apellido }}, {{ est.nombre }}</div>
                        <input pInputText [(ngModel)]="est.observacion" placeholder="Obs..." class="p-inputtext-sm w-full mt-1 visible-mobile">
                    </td>
                    <td class="text-center">
                        <p-inputnumber [(ngModel)]="est.valor_numerico" 
                                       mode="decimal" 
                                       [minFractionDigits]="2" 
                                       [min]="0" 
                                       placeholder="0.00"
                                       [showButtons]="true"
                                       buttonLayout="horizontal"
                                       spinnerMode="horizontal"
                                       inputStyleClass="text-center font-bold"
                                       decrementButtonClass="p-button-secondary"
                                       incrementButtonClass="p-button-secondary" 
                                       decrementButtonIcon="pi pi-minus" 
                                       incrementButtonIcon="pi pi-plus">
                        </p-inputnumber>
                    </td>
                    <td class="hidden-mobile">
                        <input pInputText [(ngModel)]="est.observacion" placeholder="..." class="p-inputtext-sm">
                    </td>
                    <td>
                        <button pButton icon="pi pi-eraser" class="p-button-rounded p-button-danger p-button-text" (click)="limpiarFila(est)" title="Borrar nota"></button>
                    </td>
                </tr>
            </ng-template>
        </p-table>
        <ng-template pTemplate="footer">
            <div class="flex justify-content-end pt-2">
                <button pButton label="Guardar Resultados" icon="pi pi-save" class="p-button-success w-full md:w-auto" (click)="guardarNotasFinales()"></button>
            </div>
        </ng-template>
    </p-dialog>

    <p-dialog [(visible)]="displayMainDialog" [header]="evalLogistica.id ? 'Editar Sesión' : 'Nueva Sesión'" [modal]="true" [style]="{width: '90vw', maxWidth: '400px'}" styleClass="p-fluid">
        <div class="flex flex-column gap-3 pt-2">
            <div class="field">
                <label>Grupo</label>
                <p-select [options]="grupos" [(ngModel)]="evalLogistica.grupo_id" optionLabel="nombre" optionValue="id" placeholder="Seleccionar grupo" appendTo="body"></p-select>
            </div>
            <div class="field">
                <label>Prueba Técnica</label>
                <p-select [options]="tiposEvaluacion" [(ngModel)]="evalLogistica.tipo_evaluacion_id" optionLabel="nombre" optionValue="id" placeholder="Seleccionar prueba" appendTo="body"></p-select>
            </div>
            <div class="field">
                <label>Fecha</label>
                <p-datepicker [(ngModel)]="evalLogistica.fecha" dateFormat="dd/mm/yy" appendTo="body" [showIcon]="true"></p-datepicker>
            </div>
        </div>
        <ng-template pTemplate="footer">
            <button pButton [label]="evalLogistica.id ? 'Actualizar' : 'Crear'" icon="pi pi-check" (click)="crearSesionPlanificada()"></button>
        </ng-template>
    </p-dialog>
</div>