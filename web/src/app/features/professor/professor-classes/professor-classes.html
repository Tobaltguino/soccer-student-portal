<div class="classes-container fadein animation-duration-500">
    <p-toast position="top-right"></p-toast>
    <header class="page-header">
        <div class="header-content flex align-items-center gap-3">
            <div>
                <h1>Gesti√≥n de Clases</h1>
                <p>Visualiza y organiza la planificaci√≥n t√©cnica de tus grupos.</p>
            </div>
        </div>
        <div class="header-actions flex gap-2">
            <button pButton icon="pi pi-sync" class="p-button-rounded p-button-text" 
                    (click)="cargarClasesPorGrupo()" [loading]="loading" pTooltip="Actualizar"></button>
            <button pButton label="Nueva Clase" icon="pi pi-plus" class="btn-create" 
                    (click)="abrirNuevaClase()" [disabled]="!selectedGrupoId"></button>
        </div>
    </header>

    <div class="filters-container card mb-4">
        <div class="filters-row">
            <div class="filter-item flex-grow-1" style="min-width: 200px;">
                <p-select [options]="grupos" [(ngModel)]="selectedGrupoId" optionLabel="nombre" optionValue="id" 
                          placeholder="Selecciona un grupo" (onChange)="onGrupoChange()" styleClass="w-full" appendTo="body"></p-select>
            </div>
            <div class="filter-item">
                <p-datepicker [(ngModel)]="filtroFecha" placeholder="Filtrar por Fecha" dateFormat="dd/mm/yy"
                              (ngModelChange)="aplicarFiltros()" [showClear]="true" styleClass="w-full" appendTo="body"></p-datepicker>
            </div>
            <div class="filter-item">
                <div class="p-input-icon-left w-full">
                    <input pInputText type="text" [(ngModel)]="filtroLugar" (input)="aplicarFiltros()" 
                           placeholder="Buscar por lugar" class="w-full"/>
                </div>
            </div>
            <div class="filter-item button-item flex align-items-end">
                <button pButton icon="pi pi-filter-slash" class="p-button-outlined p-button-secondary w-full" 
                        (click)="limpiarFiltros()" pTooltip="Limpiar B√∫squeda"></button>
            </div>
        </div>
    </div>

    <div class="card-table table-responsive">
        <p-table [value]="clases" [loading]="loading" [rows]="10" [paginator]="true" 
                 styleClass="p-datatable-sm" [rowHover]="true" responsiveLayout="stack" [breakpoint]="'960px'">
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 30%"><i class="pi pi-calendar"></i>Fecha / Hora</th>
                    <th style="width: 40%"><i class="pi pi-map-marker"></i>Lugar</th>
                    <th style="width: 30%" class="text-center"><i class="pi pi-cog"></i>Acciones</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-clase>
                <tr>
                    <td>
                        <span class="p-column-title">Fecha / Hora</span>
                        <div class="flex flex-column">
                            <div class="font-bold text-main">{{ clase.fecha | date:'dd/MM/yyyy' }}</div>
                            <div class="text-sm text-500 flex align-items-center mt-1">
                                <i class="pi pi-clock"></i>{{ clase.hora | slice:0:5 }} hrs
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="p-column-title">Lugar</span>
                        <div class="text-main">{{ clase.lugar || 'Cancha Principal' }}</div>
                    </td>
                    <td class="text-center">
                        <span class="p-column-title">Acciones</span>
                        <div class="action-buttons">
                            <button pButton icon="pi pi-check-square" class="p-button-text p-button-info p-button-rounded" 
                                    (click)="verAsistencia(clase)" pTooltip="Asistencia"></button>
                            <button pButton icon="pi pi-eye" class="p-button-text p-button-info p-button-rounded" 
                                    (click)="verPlanificacion(clase)" pTooltip="Ver Detalles"></button>
                            <button pButton icon="pi pi-pencil" class="p-button-text p-button-warning p-button-rounded" 
                                    (click)="abrirEditarClase(clase)" pTooltip="Editar Planificaci√≥n"></button>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <p-dialog [(visible)]="displayAttendanceDialog" [header]="'Asistencia: ' + (claseSeleccionadaAsistencia?.fecha | date: 'dd/MM/yyyy')" [modal]="true" [style]="{width: '90vw', maxWidth: '450px'}" styleClass="p-fluid">
        <ng-template pTemplate="content">
            <p-table [value]="alumnosAsistencia" [loading]="loadingAsistencia" scrollable="true" scrollHeight="300px" styleClass="p-datatable-sm">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Estudiante</th>
                        <th style="width: 80px; text-align: center;">Presente</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-alumno>
                    <tr>
                        <td class="text-sm text-main">{{ alumno.nombre }} {{ alumno.apellido }}</td>
                        <td class="text-center">
                            <p-checkbox [(ngModel)]="alumno.presente" [binary]="true"></p-checkbox>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr><td colspan="2" class="text-center p-3 text-sm text-secondary">No hay estudiantes activos en este grupo.</td></tr>
                </ng-template>
            </p-table>
        </ng-template>
        <ng-template pTemplate="footer">
            <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text" (click)="displayAttendanceDialog = false"></button>
            <button pButton label="Guardar Asistencia" icon="pi pi-check" (click)="guardarAsistencia()" [loading]="loadingAsistencia" [disabled]="alumnosAsistencia.length === 0"></button>
        </ng-template>
    </p-dialog>

    <p-dialog [(visible)]="displayPlan" header="Detalle del Entrenamiento" [modal]="true" [style]="{width: '90vw', maxWidth: '500px'}" styleClass="p-fluid">
        <div *ngIf="selectedClase" class="animation-fade-in pt-2">
            <div class="field mb-4">
                <label class="font-bold text-primary"><i class="pi pi-directions"></i> Objetivo Principal</label>
                <div class="surface-ground p-3 border-round border-1 border-200">
                    {{ selectedClase.objetivo && selectedClase.objetivo !== 'EMPTY' ? selectedClase.objetivo : 'Sin objetivo definido' }}
                </div>
            </div>
            <div class="formgrid grid">
                <div class="field col-12 mb-3">
                    <label class="font-bold"><span class="mr-2">üî•</span> Calentamiento</label>
                    <div class="text-sm bg-gray-100 p-3 border-round border-1 border-200" style="white-space: pre-wrap;">
                        {{ selectedClase.calentamiento && selectedClase.calentamiento !== 'EMPTY' ? selectedClase.calentamiento : 'No especificado' }}
                    </div>
                </div>
                <div class="field col-12 mb-3">
                    <label class="font-bold"><span class="mr-2">‚öΩ</span> Parte Principal</label>
                    <div class="text-sm bg-gray-100 p-3 border-round border-1 border-200" style="white-space: pre-wrap;">
                        {{ selectedClase.parte_principal && selectedClase.parte_principal !== 'EMPTY' ? selectedClase.parte_principal : 'No especificada' }}
                    </div>
                </div>
                <div class="field col-12 mb-3">
                    <label class="font-bold"><span class="mr-2">‚ùÑÔ∏è</span> Vuelta a la Calma</label>
                    <div class="text-sm bg-gray-100 p-3 border-round border-1 border-200" style="white-space: pre-wrap;">
                        {{ selectedClase.vuelta_calma && selectedClase.vuelta_calma !== 'EMPTY' ? selectedClase.vuelta_calma : 'No especificada' }}
                    </div>
                </div>
            </div>
        </div>
        <ng-template pTemplate="footer">
            <button pButton label="Cerrar" icon="pi pi-times" class="p-button-text" (click)="displayPlan = false"></button>
        </ng-template>
    </p-dialog>

    <p-dialog [(visible)]="displayForm" [header]="isEditing ? 'Editar Clase' : 'Nueva Clase'" 
              [modal]="true" [style]="{width: '90vw', maxWidth: '550px'}" styleClass="p-fluid">
        <ng-template pTemplate="content">
            <div class="flex justify-content-center mb-4 mt-2">
                <p-selectButton [options]="opcionesVistaForm" [(ngModel)]="vistaFormulario" optionLabel="label" optionValue="value">
                    <ng-template let-item pTemplate="item">
                        <i [class]="item.icon" class="mr-2"></i>
                        <span>{{item.label}}</span>
                    </ng-template>
                </p-selectButton>
            </div>
            <div *ngIf="vistaFormulario === 'logistica'" class="animation-fade-in">
                
                <div class="field">
                    <label><i class="pi pi-users"></i> Grupo Asignado <span class="text-red-500 font-bold">*</span></label>
                    <p-select [options]="grupos" [(ngModel)]="claseForm.grupo_id" optionLabel="nombre" optionValue="id" 
                              [disabled]="true" appendTo="body"></p-select>
                </div>
                
                <div class="formgrid grid">
                    <div class="field col-6">
                        <label><i class="pi pi-calendar"></i> Fecha <span class="text-red-500 font-bold">*</span></label>
                        <p-datepicker [(ngModel)]="claseForm.fecha" dateFormat="dd/mm/yy" appendTo="body" [showIcon]="true"></p-datepicker>
                    </div>
                    <div class="field col-6">
                        <label><i class="pi pi-clock"></i> Hora <span class="text-red-500 font-bold">*</span></label>
                        <input pInputText type="time" [(ngModel)]="claseForm.hora" class="w-full">
                    </div>
                </div>
                
                <div class="field">
                    <label><i class="pi pi-map-marker"></i> Lugar / Cancha <span class="text-red-500 font-bold">*</span></label>
                    <input pInputText [(ngModel)]="claseForm.lugar" placeholder="Ej: Cancha 3" />
                </div>
                
            </div>
            <div *ngIf="vistaFormulario === 'planificacion'" class="animation-fade-in">
                <div class="field">
                    <label class="font-bold text-primary"><i class="pi pi-directions"></i> Objetivo Principal</label>
                    <input pInputText [(ngModel)]="claseForm.objetivo" placeholder="Ej: Mejora del pase corto" />
                </div>
                <div class="field">
                    <label><span class="mr-2">üî•</span> Calentamiento</label>
                    <textarea pInputText class="w-full p-2 border-round surface-border" [(ngModel)]="claseForm.calentamiento" rows="3" placeholder="Descripci√≥n del calentamiento..."></textarea>
                </div>
                <div class="field">
                    <label><span class="mr-2">‚öΩ</span> Parte Principal</label>
                    <textarea pInputText class="w-full p-2 border-round surface-border" [(ngModel)]="claseForm.parte_principal" rows="4" placeholder="Ejercicios principales..."></textarea>
                </div>
                <div class="field">
                    <label><span class="mr-2">‚ùÑÔ∏è</span> Vuelta a la Calma</label>
                    <textarea pInputText class="w-full p-2 border-round surface-border" [(ngModel)]="claseForm.vuelta_calma" rows="2" placeholder="Estiramientos finales..."></textarea>
                </div>
            </div>
        </ng-template>
        <ng-template pTemplate="footer">
            <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text p-button-secondary" (click)="displayForm = false" [disabled]="saving"></button>
            <button pButton label="Guardar" icon="pi pi-check" class="p-button-primary" (click)="guardarClase()" [loading]="saving"></button>
        </ng-template>
    </p-dialog>
</div>